@page "{accessLink}"
@model SteadyBooks.Pages.Dashboard.ViewModel
@{
    ViewData["Title"] = Model.Dashboard?.DashboardName ?? "Dashboard";
    Layout = "_DashboardLayout";
}

@if (Model.Dashboard == null)
{
    <div class="container py-5">
        <div class="alert alert-danger text-center">
            <i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i>
            <h3 class="mt-3">Dashboard Not Found</h3>
            <p class="mb-0">The dashboard you're looking for doesn't exist or has been removed.</p>
        </div>
    </div>
}
else if (!Model.Dashboard.IsActive)
{
    <div class="container py-5">
        <div class="alert alert-warning text-center">
            <i class="bi bi-lock" style="font-size: 3rem;"></i>
            <h3 class="mt-3">Dashboard Unavailable</h3>
            <p class="mb-0">This dashboard is currently unavailable. Please contact your accountant for assistance.</p>
            @if (!string.IsNullOrEmpty(Model.Dashboard.Firm?.PrimaryContactEmail))
            {
                <hr>
                <p class="mb-0">
                    <a href="mailto:@Model.Dashboard.Firm.PrimaryContactEmail" class="btn btn-primary mt-2">
                        <i class="bi bi-envelope me-2"></i>Contact @Model.Dashboard.Firm.FirmName
                    </a>
                </p>
            }
        </div>
    </div>
}
else
{
    <div class="container py-4">
        <!-- Header with Firm Branding -->
        <div class="card shadow-sm mb-4" style="border-top: 4px solid @(Model.Dashboard.Firm?.BrandColor ?? "#667eea");">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center flex-wrap">
                    <div class="mb-2 mb-md-0">
                        @if (!string.IsNullOrEmpty(Model.Dashboard.Firm?.LogoPath))
                        {
                            <img src="@Model.Dashboard.Firm.LogoPath" alt="@Model.Dashboard.Firm.FirmName" 
                                 style="max-height: 50px; max-width: 250px; object-fit: contain;" class="mb-2" />
                        }
                        else
                        {
                            <h4 class="mb-2 text-muted">@Model.Dashboard.Firm?.FirmName</h4>
                        }
                        <h2 class="h4 mb-1">@(Model.Dashboard.Configuration?.CustomTitle ?? Model.Dashboard.DashboardName)</h2>
                        @if (!string.IsNullOrEmpty(Model.Dashboard.ClientCompanyName))
                        {
                            <p class="text-muted mb-0"><i class="bi bi-building me-1"></i>@Model.Dashboard.ClientCompanyName</p>
                        }
                    </div>
                    <div class="text-md-end">
                        <small class="text-muted d-block">Last Updated</small>
                        <strong>@Model.Dashboard.ModifiedDate.ToString("MMM dd, yyyy")</strong>
                        <br>
                        <small class="text-muted">@Model.DateRangeDisplay</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Welcome Message (if configured) -->
        @if (!string.IsNullOrEmpty(Model.Dashboard.Configuration?.WelcomeMessage))
        {
            <div class="alert alert-info shadow-sm mb-4">
                <i class="bi bi-info-circle me-2"></i>
                @Model.Dashboard.Configuration.WelcomeMessage
            </div>
        }

        <!-- Financial Metrics Cards -->
        <div class="row g-4 mb-4">
            @if (Model.Dashboard.Configuration?.ShowCashBalance ?? true)
            {
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="card shadow-sm h-100">
                        <div class="card-body text-center">
                            <div class="mb-2">
                                <i class="bi bi-cash-coin text-success" style="font-size: 2.5rem;"></i>
                            </div>
                            <h6 class="text-muted text-uppercase small mb-2">Cash Balance</h6>
                            <h2 class="mb-1">$@Model.MockData.CashBalance.ToString("N0")</h2>
                            <small class="text-success">
                                <i class="bi bi-arrow-up"></i> @Model.MockData.CashChange%
                            </small>
                        </div>
                    </div>
                </div>
            }

            @if (Model.Dashboard.Configuration?.ShowProfit ?? true)
            {
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="card shadow-sm h-100">
                        <div class="card-body text-center">
                            <div class="mb-2">
                                <i class="bi bi-graph-up text-primary" style="font-size: 2.5rem;"></i>
                            </div>
                            <h6 class="text-muted text-uppercase small mb-2">Profit</h6>
                            <h2 class="mb-1">$@Model.MockData.Profit.ToString("N0")</h2>
                            <small class="@(Model.MockData.ProfitChange >= 0 ? "text-success" : "text-danger")">
                                <i class="bi bi-arrow-@(Model.MockData.ProfitChange >= 0 ? "up" : "down")"></i> @Model.MockData.ProfitChange%
                            </small>
                        </div>
                    </div>
                </div>
            }

            @if (Model.Dashboard.Configuration?.ShowTaxesDue ?? true)
            {
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="card shadow-sm h-100">
                        <div class="card-body text-center">
                            <div class="mb-2">
                                <i class="bi bi-receipt text-warning" style="font-size: 2.5rem;"></i>
                            </div>
                            <h6 class="text-muted text-uppercase small mb-2">Taxes Due</h6>
                            <h2 class="mb-1">$@Model.MockData.TaxesDue.ToString("N0")</h2>
                            <small class="text-muted">Estimated</small>
                        </div>
                    </div>
                </div>
            }

            @if (Model.Dashboard.Configuration?.ShowOutstandingInvoices ?? true)
            {
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="card shadow-sm h-100">
                        <div class="card-body text-center">
                            <div class="mb-2">
                                <i class="bi bi-file-earmark-text text-info" style="font-size: 2.5rem;"></i>
                            </div>
                            <h6 class="text-muted text-uppercase small mb-2">Outstanding Invoices</h6>
                            <h2 class="mb-1">$@Model.MockData.OutstandingInvoices.ToString("N0")</h2>
                            <small class="text-muted">@Model.MockData.InvoiceCount invoices</small>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Additional Information -->
        <div class="row g-4 mb-4">
            <!-- Revenue vs Expenses Chart Placeholder -->
            <div class="col-md-8">
                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Revenue vs Expenses</h5>
                    </div>
                    <div class="card-body">
                        <div class="text-center py-5">
                            <i class="bi bi-graph-up-arrow text-muted" style="font-size: 4rem;"></i>
                            <p class="text-muted mt-3 mb-0">Interactive charts coming soon</p>
                            <small class="text-muted">Connect to QuickBooks Online for detailed analytics</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="col-md-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>Quick Stats</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
                            <span class="text-muted">Revenue</span>
                            <strong class="text-success">$@Model.MockData.Revenue.ToString("N0")</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
                            <span class="text-muted">Expenses</span>
                            <strong class="text-danger">$@Model.MockData.Expenses.ToString("N0")</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
                            <span class="text-muted">Margin</span>
                            <strong>@Model.MockData.Margin%</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Bank Accounts</span>
                            <strong>@Model.MockData.BankAccountCount</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contact & Support -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="mb-2"><i class="bi bi-question-circle me-2"></i>Questions About Your Finances?</h5>
                        <p class="text-muted mb-md-0">
                            Your accountant is here to help. Reach out for any questions or clarifications about these numbers.
                        </p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        @if (!string.IsNullOrEmpty(Model.Dashboard.Firm?.PrimaryContactEmail))
                        {
                            <a href="mailto:@Model.Dashboard.Firm.PrimaryContactEmail" class="btn btn-outline-primary mb-2 d-block d-md-inline-block">
                                <i class="bi bi-envelope me-2"></i>@Model.Dashboard.Firm.PrimaryContactEmail
                            </a>
                        }
                        @if (!string.IsNullOrEmpty(Model.Dashboard.Firm?.ContactPhone))
                        {
                            <a href="tel:@Model.Dashboard.Firm.ContactPhone" class="btn btn-outline-secondary d-block d-md-inline-block">
                                <i class="bi bi-telephone me-2"></i>@Model.Dashboard.Firm.ContactPhone
                            </a>
                        }
                    </div>
                </div>
            </div>
            @if (!string.IsNullOrEmpty(Model.Dashboard.Firm?.FooterMessage))
            {
                <div class="card-footer text-center text-muted small bg-light">
                    @Model.Dashboard.Firm.FooterMessage
                </div>
            }
        </div>

        <!-- Data Disclaimer -->
        <div class="alert alert-secondary small text-center mb-0">
            <i class="bi bi-shield-check me-1"></i>
            <strong>Secure Dashboard:</strong> This dashboard is encrypted and only accessible via your unique link. Data is synced from QuickBooks Online.
            <br>
            <small class="text-muted">Last synced: @Model.Dashboard.ModifiedDate.ToString("MMM dd, yyyy h:mm tt")</small>
        </div>
    </div>
}
